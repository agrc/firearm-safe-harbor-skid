name: Deploy
description: Deploy to GCP
inputs:
  project_id:
    description: "The GCP project ID"
    required: true
  identity_provider:
    description: "The identity provider for the workload identity"
    required: true
  service_account_email:
    description: "The service account email"
    required: true
  github_token:
    description: "The GitHub token"
    required: true
  shared_vpc_network:
    description: "The shared VPC network to use"
    required: false
  shared_vpc_subnet:
    description: "The shared VPC subnet to use"
    required: false

runs:
  using: composite
  steps:
    - name: ğŸ—ï¸ Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v3
      with:
        workload_identity_provider: ${{ inputs.identity_provider }}
        service_account: ${{ inputs.service_account_email }}
        token_format: "access_token"

    - name: ğŸ³ Set up Docker Buildx
      id: builder
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Authenticate Docker to Google Cloud
      uses: docker/login-action@v3
      with:
        registry: us-central1-docker.pkg.dev
        username: oauth2accesstoken
        password: ${{ steps.auth.outputs.access_token }}

    - name: ğŸ·ï¸ Extract tags from GitHub
      id: meta
      uses: docker/metadata-action@v5
      with:
        github-token: ${{ inputs.github_token }}
        images: us-central1-docker.pkg.dev/${{ inputs.project_id }}/images/job
        tags: |
          type=ref,suffix=-{{sha}},event=branch
          type=ref,prefix=pr-,suffix=-{{sha}},event=pr
          type=semver,pattern={{version}}
          latest

    - name: ğŸ“¦ Build and push image
      uses: docker/build-push-action@v6
      with:
        builder: ${{ steps.builder.outputs.name }}
        tags: ${{ steps.meta.outputs.tags }}
        context: .
        file: ./Dockerfile
        push: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: ğŸš€ Deploy Cloud Run Job
      uses: google-github-actions/deploy-cloudrun@v3
      with:
        project_id: ${{ inputs.project_id }}
        region: us-west3
        image: us-central1-docker.pkg.dev/${{ inputs.project_id }}/images/job:latest
        job: default
        secrets: /secrets/app/secrets.json=skid-secrets:latest
        secrets_update_strategy: overwrite
        timeout: 30m
        flags: |
          --memory=1Gi
          --task-timeout=10m
          --max-retries=0
          --service-account=cloud-run-sa@${{ inputs.project_id }}.iam.gserviceaccount.com
          --network=${{ inputs.shared_vpc_network }}
          --subnet=${{ inputs.shared_vpc_subnet }}
          --vpc-egress=all-traffic
